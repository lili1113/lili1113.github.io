<!DOCTYPE html>
<html>
<head>
    <style>
        /* 基础样式...（保留之前的样式） */

        /* 新增控制面板样式 */
        .control-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .control-group {
            margin-bottom: 15px;
        }

        button {
            padding: 8px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #4CAF50;
            color: white;
            transition: background 0.3s;
        }

        button.delete {
            background: #f44336;
        }

        /* 完善编辑面板样式 */
        #editPanel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--node-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1001;
        }

        .selected {
            outline: 2px solid #2196F3 !important;
        }
    </style>
</head>
<body>
    <!-- 新增控制面板 -->
    <div class="control-panel">
        <div class="control-group">
            <button onclick="createRootNode()">+ 添加根节点</button>
            <button class="delete" onclick="deleteSelectedNode()">- 删除选中节点</button>
            <button class="delete" onclick="clearAllNodes()">清空所有节点</button>
        </div>
        <div class="control-group">
            <span id="selectedInfo">当前选中节点：无</span>
        </div>
    </div>

    <!-- 保留原有结构... -->

<script>
// 原有数据结构和基础函数...

// 新增控制函数
function createRootNode() {
    const position = {
        x: window.innerWidth/2 - 60,
        y: 100
    };
    createNode(null, position);
}

function deleteNode(nodeId) {
    // 递归删除所有子节点
    const deleteRecursive = (id) => {
        nodes = nodes.filter(n => n.id !== id);
        nodes.filter(n => n.parentId === id).forEach(n => deleteRecursive(n.id));
    }
    deleteRecursive(nodeId);
    saveTree();
    renderTree();
}

function deleteSelectedNode() {
    if (selectedNodeId) {
        deleteNode(selectedNodeId);
        selectedNodeId = null;
    }
}

function clearAllNodes() {
    if (confirm("确定要清空所有节点吗？")) {
        nodes = [];
        saveTree();
        renderTree();
    }
}

// 完善节点选择功能
function selectNode(nodeId) {
    selectedNodeId = nodeId;
    document.querySelectorAll('.skill-node').forEach(n => n.classList.remove('selected'));
    document.querySelector(`.skill-node[data-id="${nodeId}"]`).classList.add('selected');
    document.getElementById('selectedInfo').textContent = `当前选中节点：${nodeId}`;
}

// 修改后的节点渲染
function renderTree() {
    const container = document.getElementById('tree');
    container.innerHTML = '';
    
    nodes.forEach(node => {
        if (node.parentId) {
            const parent = nodes.find(n => n.id === node.parentId);
            drawConnection(parent.position, node.position);
        }
    });

    nodes.forEach(node => {
        const nodeEl = document.createElement('div');
        nodeEl.className = `skill-node ${node.completed ? 'completed' : ''}`;
        nodeEl.style.left = `${node.position.x}px`;
        nodeEl.style.top = `${node.position.y}px`;
        nodeEl.setAttribute('data-id', node.id);
        nodeEl.innerHTML = `
            <h4>节点 ${node.id}</h4>
            <div>进度：${node.loggedHours}/${node.planHours}h</div>
            <div>${node.completed ? '✓ 已完成' : '进行中'}</div>
        `;

        nodeEl.onclick = (e) => {
            e.stopPropagation();
            selectNode(node.id);
            showEditPanel(node);
        };

        nodeEl.oncontextmenu = (e) => {
            e.preventDefault();
            showContextMenu(e, node);
        };

        container.appendChild(nodeEl);
    });
}

// 完善编辑面板功能
function showEditPanel(node) {
    const panel = document.getElementById('editPanel');
    panel.innerHTML = `
        <h3>编辑节点 ${node.id}</h3>
        <div class="form-group">
            <label>计划时长：</label>
            <input type="number" id="planHours" value="${node.planHours}">
        </div>
        <div class="form-group">
            <label>添加学习时长：</label>
            <input type="number" id="addHours" min="0">
        </div>
        <div class="form-group">
            <label>学习笔记：</label>
            <textarea id="notes" rows="4">${node.notes}</textarea>
        </div>
        <button onclick="saveNodeChanges(${node.id})">保存</button>
        <button onclick="this.parentElement.style.display='none'">关闭</button>
    `;
    panel.style.display = 'block';
}

function saveNodeChanges(nodeId) {
    const node = nodes.find(n => n.id === nodeId);
    node.planHours = parseInt(document.getElementById('planHours').value) || 0;
    node.loggedHours += parseInt(document.getElementById('addHours').value) || 0;
    node.notes = document.getElementById('notes').value;
    
    if (node.loggedHours >= node.planHours && node.planHours > 0) {
        node.completed = true;
    }
    
    saveTree();
    renderTree();
}

// 实现连接线绘制
function drawConnection(start, end) {
    const container = document.getElementById('tree');
    const line = document.createElement('div');
    line.className = 'connector';
    
    const length = Math.sqrt(
        Math.pow(end.x - start.x, 2) + 
        Math.pow(end.y - start.y, 2)
    );
    
    const angle = Math.atan2(
        end.y - start.y,
        end.x - start.x
    );
    
    line.style.width = `${length}px`;
    line.style.left = `${start.x + 60}px`;  // 60为节点宽度的一半
    line.style.top = `${start.y + 20}px`;   // 20为节点高度的一半
    line.style.transform = `rotate(${angle}rad)`;
    
    container.appendChild(line);
}

// 点击空白处取消选择
document.body.onclick = (e) => {
    if (!e.target.closest('.skill-node') && !e.target.closest('#editPanel')) {
        selectedNodeId = null;
        document.querySelectorAll('.skill-node').forEach(n => n.classList.remove('selected'));
        document.getElementById('selectedInfo').textContent = '当前选中节点：无';
        document.getElementById('editPanel').style.display = 'none';
    }
};

// 初始化...
</script>
</body>
</html>
