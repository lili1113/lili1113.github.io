<!DOCTYPE html>
<html>
<head>
    <style>
        /* 保留之前的样式 */
        .context-menu {
            position: fixed;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            border-radius: 5px;
            padding: 10px;
            z-index: 1002;
        }
        .context-menu-item {
            padding: 8px 15px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .context-menu-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <!-- 保留之前的HTML结构 -->

<script>
// 在SkillNode类中添加parent引用
class SkillNode {
    constructor(id, parentId, position) {
        this.id = id;
        this.parentId = parentId;
        this.position = position;
        this.planHours = 0;
        this.loggedHours = 0;
        this.notes = "";
        this.completed = false;
        this.children = [];
    }

    get parent() {
        return nodes.find(n => n.id === this.parentId);
    }
}

// 新增添加父节点功能
function addParentNode(childId) {
    const childNode = nodes.find(n => n.id === childId);
    if (!childNode) return;

    // 创建新父节点
    const newParent = new SkillNode(
        Date.now(),
        childNode.parentId,
        {x: childNode.position.x, y: childNode.position.y - 100}
    );

    // 更新关系
    if (childNode.parentId) {
        const originalParent = childNode.parent;
        originalParent.children = originalParent.children.filter(id => id !== childId);
        originalParent.children.push(newParent.id);
    }
    
    newParent.children.push(childId);
    childNode.parentId = newParent.id;
    
    nodes.push(newParent);
    saveTree();
    renderTree();
}

// 改进的上下文菜单
function showContextMenu(e, node) {
    const menu = document.createElement('div');
    menu.className = 'context-menu';
    menu.style.left = `${e.clientX}px`;
    menu.style.top = `${e.clientY}px`;
    
    menu.innerHTML = `
        <div class="context-menu-item" onclick="createNode(${node.id}, getNewChildPosition(${node.id}))">添加子节点</div>
        <div class="context-menu-item" onclick="addParentNode(${node.id})">添加父节点</div>
        <div class="context-menu-item" onclick="insertSiblingNode(${node.id})">添加同级节点</div>
        <hr>
        <div class="context-menu-item" style="color:red" onclick="deleteNode(${node.id})">删除节点</div>
    `;

    document.body.appendChild(menu);
    
    // 点击其他地方关闭菜单
    const closeMenu = () => {
        menu.remove();
        document.removeEventListener('click', closeMenu);
    };
    document.addEventListener('click', closeMenu);
}

// 自动定位新节点位置
function getNewChildPosition(parentId) {
    const parent = nodes.find(n => n.id === parentId);
    const childCount = parent.children.length;
    return {
        x: parent.position.x + (childCount * 140) - 70,
        y: parent.position.y + 100
    };
}

// 添加同级节点功能
function insertSiblingNode(siblingId) {
    const current = nodes.find(n => n.id === siblingId);
    if (!current.parentId) return createRootNode();
    
    const parent = current.parent;
    const newPosition = {
        x: parent.position.x + (parent.children.length * 140),
        y: parent.position.y + 100
    };
    
    createNode(parent.id, newPosition);
}

// 修改后的节点创建逻辑
function createNode(parentId, position) {
    const newNode = new SkillNode(Date.now(), parentId, position);
    nodes.push(newNode);
    
    if (parentId) {
        const parent = nodes.find(n => n.id === parentId);
        parent.children.push(newNode.id);
    }
    
    saveTree();
    renderTree();
}

// 保留其他原有函数...
</script>
</body>
</html>
